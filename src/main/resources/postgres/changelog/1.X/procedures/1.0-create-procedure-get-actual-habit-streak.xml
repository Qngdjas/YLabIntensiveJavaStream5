<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd"
                   logicalFilePath="postgres/1.X/changelog.xml">

    <changeSet id="1.0-create-procedure-get-actual-habit-streak"
               author="Qngdjas">

        <createProcedure procedureName="GetActualHabitStreak"
                         schemaName="public">

            CREATE OR REPLACE PROCEDURE GetActualHabitStreak(IN habitId INT, INOUT actualStreak INT default 0)
            LANGUAGE plpgsql AS $$
            DECLARE
                isDaily BOOLEAN;
                streak INT := 0;
                lastNotedDate DATE;
                dayCount INT;
                counter INT;
            BEGIN
                SELECT h.daily_flag INTO isDaily
                FROM entity.habits AS h
                WHERE h.habit_id = habitId;
                IF isDaily THEN
                    dayCount := 1;
                ELSE
                    dayCount := 7;
                END IF;
                SELECT MAX(noted_date) INTO lastNotedDate
                FROM habit_notes
                WHERE habit_id = habitId;
                counter := dayCount;
                WHILE lastNotedDate IS NOT NULL and counter &gt; 0 LOOP
                    IF EXISTS (
                        SELECT 1
                        FROM habit_notes
                        WHERE habit_id = habitId
                        AND noted_date &lt; lastNotedDate + dayCount
                        AND noted_date &gt;= lastNotedDate
                    ) THEN
                        streak := streak + 1;
                        counter := dayCount;
                    ELSE
                        counter := counter - 1;
                    END IF;
                    SELECT MAX(noted_date) INTO lastNotedDate
                    FROM habit_notes
                    WHERE habit_id = habitId
                    AND noted_date &lt; lastNotedDate;
                END LOOP;
                actualstreak := streak;
            END;
            $$;



        </createProcedure>

    </changeSet>

</databaseChangeLog>